;; QN_ACTR_Model_Initialization driving test OpenDS
;; QN-ACTR, Sample Driving (Modeling driving)
;; For questions and comments, please send to Shi Cao (shicao@umich.edu).

;;;;;;;;;;;;;;;;;;;;;
;; Task definition ;;
;;;;;;;;;;;;;;;;;;;;;

(use_world3d_template   
	:method    	driving    ;; the refresh rate will be syncronized to OpenDS (for TORCS it's about 50 Hz, 20 ms each cycle)
)

(use_predefined_model_setup		model_drive_opends)
;; the model will be connected with OpenDS. Road and scenario settings are done in OpenDS.

;;;;;;;;;;;;;;;;;;;;;
;; Mind definition ;;
;;;;;;;;;;;;;;;;;;;;;

(sgp :esc t :rt -0.5 :bll 0.5 :ans 0.5 :lf 0.4) 

;; driving-control based on Salvucci (2006) driving model with two-point visual-motor control

(chunk-type drive-control	;; both lateral and longitudinal controls 
        lane  			;; target driving lane, 0 for center lane, -1 for 1st on the left, 1 for 1st on the right
	na-old			;; near angle old (degree)
	na-new			;; near angle new (degree)	
	fa-old			;; far angle old  (degree)
	fd-old			;; far point distance (m)
	time-old
	speed-old		;; in m/ s/s

	stage			 
)

(chunk-type world3d-driving-criticalelement-vehicle screen-pos id color)
(chunk-type world3d-driving-criticalelement-sign screen-pos id content)
(chunk-type world3d-driving-criticalelement-vehicle-img id color)
(chunk-type world3d-driving-criticalelement-sign-img id content)
(chunk-type world3d-driving-speed screen-pos speed)
(chunk-type world3d-driving-speed-img speed)
(chunk-type visual-location-world3d-driving-criticalelement kind id viewarea :attended) ;;mind use lowercase
(chunk-type visual-location-world3d-driving-speed :attended value) 



(add-dm
 (driving isa drive-control 
	lane		0
	na-old		0
	na-new		0
	fa-old		0
        fd-old          0	;; because far distance is determined by speed * far-time
	time-old	0
	speed-old	0	;; use initial speed
	stage		attending-near
 )

)



(p drive-control-attend-near
   =goal>
      isa drive-control
      lane =lane
      stage attending-near

==>
   +visual-location>
      isa  visual-location-world3d-driving
      kind near-point
      lane =lane   
   =goal>
      stage processing-near-attending-far
)

(p drive-control-process-near-attend-far
   =goal>
      isa drive-control
      lane 	=lane
      na-new    =na-1
      stage 	processing-near-attending-far
   =visual-location>
      isa  visual-location-world3d-driving
      kind near-point
      angle   =na-2


==>
   =goal>
      na-old 	=na-1      
      na-new    =na-2
      stage     processing-far
   +visual-location>
      isa visual-location-world3d-driving
      kind far-point		;;this far point will include both road far points and car far points
      lane =lane		;;here may find both far-road point and far-car point, use the closest one
)


(p drive-control-process-far
   =goal>
      isa drive-control      
      lane =lane
      na-old 	=na-old
      na-new    =na-new
      fa-old    =fa-1
      fd-old    =fd-1
      speed-old =v-1
      time-old  =time-1
      stage     processing-far
   =visual-location>
      isa 	visual-location-world3d-driving
      kind 	far-point
      angle	=fa-2
      distance 	=fd-2
   ?visual>
      state 	free
 
   ?manual>
      state   free

==>
!bind! =time-2 (get-clock-time)     ;; the short-cut way  
!bind! =v-2  (world3d-driving-get-velocity)   ;; the short-cut way 
   =goal>
      fa-old =fa-2
      fd-old =fd-2
      speed-old =v-2
      time-old =time-2
      stage     attending-speed
   +visual>
      isa         move-attention 		;;note here as in Salvucci's model, near and far angle is not computed from visual but use visual-location only. this +visual> is used for showing eye movement, in fact as a side effect. info processing is not affected by visual prepare, encoding and eye movement speed
      screen-pos  =visual-location
   +manual>
      isa	world3d-driving-two-point-visual-manual-steer
      na-old 	=na-old
      na-new    =na-new
      fa-old    =fa-1     
      fa-new    =fa-2
      time-old  =time-1
      time-new  =time-2

!eval! (world3d-driving-accelerate-brake   =fd-1   =fd-2  =v-1  =v-2    =time-1      =time-2  ) 	;;currently no module for this, just !eval! as Salvucci's model

)

(p drive-control-attend-speed
   =goal>
      isa drive-control
      stage attending-speed
==>
   +visual-location>
      isa  visual-location-world3d-driving-speed
   =goal>
      stage processing-speed
)

(p drive-control-process-speed
   =goal>
      isa drive-control
      stage 	processing-speed
   =visual-location>
      isa  visual-location-world3d-driving-speed
    ?visual>
     state     free
==>
    +visual>               
      isa      move-attention
      screen-pos =visual-location
   =goal>
      stage     reading-speed
)

(p read-speed
    =goal>
      isa drive-control  
      stage    reading-speed
    =visual>
      isa      world3d-driving-speed
	speed	=v

==>
    =goal>
      stage    attending-critical
!eval! (world3d-driving-report-speed  =v) 
    +imaginal>
      isa      world3d-driving-speed-img
	speed	=v
   -imaginal> ;;to put this chunk into declarative memory
)

(p attend-criticalelement
    =goal>
      isa drive-control  
      stage    attending-critical
   ==>
!bind! =view (world3d-driving-choosing-viewArea)
    =goal>
      stage    critical-detect-result
   +visual-location>
      isa visual-location-world3d-driving-criticalelement
      kind critical-element
	viewArea =view		
)

(p attend-criticalelement-detected
    =goal>
      isa drive-control  
      stage    critical-detect-result
    =visual-location>
      isa visual-location-world3d-driving-criticalelement
      kind critical-element
    ?visual>
     state     free
   ==>
    +visual>               
      isa      move-attention
      screen-pos =visual-location
    =goal>
      stage    reading-critical
)

(p attend-criticalelement-detect-failure
    =goal>
      isa drive-control  
      stage    critical-detect-result
    ?visual-location>
      state error
   ==>
    =goal>
      stage    recalling-sign
)

(p read-criticalelement-vehicle
    =goal>
      isa drive-control  
      stage    reading-critical
    =visual>
      isa      world3d-driving-criticalelement-vehicle
	id	=i
      color    =col

==>
    =goal>
      stage    recalling-sign
!eval! (world3d-driving-report-criticalelement-vehicle  =col) 
    +imaginal>
      isa      world3d-driving-criticalelement-vehicle-img
	id	=i
      color    =col
   -imaginal> ;;to put this chunk into declarative memory
)

(p read-criticalelement-sign
    =goal>
      isa drive-control  
      stage    reading-critical
    =visual>
      isa      world3d-driving-criticalelement-sign
	id	=i
      content    =cont

==>
    =goal>
      stage    recalling-sign
!eval! (world3d-driving-report-criticalelement-sign  =cont) 
    +imaginal>
      isa      world3d-driving-criticalelement-sign-img
	id	=i
      content    =cont
   -imaginal> ;;to put this chunk into declarative memory
)

(p read-criticalelement-failure
    =goal>
      isa drive-control  
      stage    reading-critical
    ?visual>
      state error

==>
    =goal>
      stage    recalling-sign
)

(p recall-sign
    =goal>
      isa      drive-control  
      stage    recalling-sign
==>
    +retrieval>
      isa      world3d-driving-criticalelement-sign-img
    =goal>
      stage    recall-sign-result
)

(p recall-sign-success
    =goal>
      isa      drive-control  
      stage    recall-sign-result
    =retrieval>
      isa      world3d-driving-criticalelement-sign-img
      content    =cont
==>
    =goal>
      stage    recalling-vehicle
!eval! (world3d-driving-recall-criticalelement-sign  =cont)
)

(p cannot-recall-sign
    =goal>
      isa      drive-control  
      stage    recall-sign-result
    ?retrieval>
      state   error
   ==>
    =goal>
      stage    recalling-vehicle
!eval! (world3d-driving-recall-criticalelement-sign nil )
)

(p recall-vehicle
    =goal>
      isa      drive-control  
      stage    recalling-vehicle
==>
    +retrieval>
      isa      world3d-driving-criticalelement-vehicle-img
    =goal>
      stage    recall-vehicle-result
)

(p recall-sign-success
    =goal>
      isa      drive-control  
      stage    recall-vehicle-result
    =retrieval>
      isa      world3d-driving-criticalelement-vehicle-img
      color	=col
==>
    =goal>
      stage    recalling-speed
!eval! (world3d-driving-recall-criticalelement-vehicle  =col)
)

(p cannot-recall-sign
    =goal>
      isa      drive-control  
      stage    recall-vehicle-result
    ?retrieval>
      state   error
   ==>
    =goal>
      stage    recalling-speed
!eval! (world3d-driving-recall-criticalelement-vehicle  nil )
)

(p recall-speed
    =goal>
      isa      drive-control  
      stage    recalling-speed
==>
    +retrieval>
      isa      world3d-driving-speed-img
    =goal>
      stage    recall-speed-result
)

(p recall-speed-success
    =goal>
      isa      drive-control  
      stage    recall-speed-result
    =retrieval>
      isa      world3d-driving-speed-img
	speed	=v
==>
    =goal>
      stage    attending-near
!eval! (world3d-driving-recall-speed  =v)
)

(p cannot-recall-speed
    =goal>
      isa      drive-control  
      stage    recall-speed-result
    ?retrieval>
      state   error
   ==>
    =goal>
      stage    attending-near
!eval! (world3d-driving-recall-speed  nil )
)

(goal-focus driving)